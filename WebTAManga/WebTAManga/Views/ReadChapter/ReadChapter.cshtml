@model WebTAManga.Models.Chapter

<link rel="stylesheet" href="~/css/readchapter.css" asp-append-version="true" />

<div class="container mt-5">
    <h2>@Model.ChapterTitle</h2>
    <p class="text-muted">Published on @Model.CreatedAt?.ToString("yyyy-MM-dd")</p>

    <div class="mt-4">
        @if (ViewBag.IsUnlocked || ViewBag.IsPurchased)
        {
            <!-- Hiển thị nội dung chapter nếu đã mở khóa hoặc đã mua -->
            @if (Model.ChapterImages != null && Model.ChapterImages.Any())
            {
                <div class="row justify-content-center">
                    @foreach (var image in Model.ChapterImages.OrderBy(i => i.PageNumber))
                    {
                        <div class="col-12 text-center">
                            <img src="~/@image.ImageUrl" alt="Page @image.PageNumber" class="img-fluid chapter-image">
                        </div>
                    }
                </div>
            }
            else
            {
                <p>No images available for this chapter.</p>
            }
        }
        else
        {
            <!-- Thông báo chapter bị khóa và nút mở khóa -->
            <div class="chapter-locked">
                <p>Chapter này đã bị khóa. Sử dụng <strong>@Model.Coins</strong> xu để mở khóa.</p>
                <form method="post" asp-controller="BuyChapter" asp-action="BuyChapter" asp-route-chapterId="@Model.ChapterId">
                    <button type="submit" class="btn btn-unlock">Mua ngay</button>
                </form>
            </div>
        }
    </div>
</div>


@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger mt-3">
        @TempData["ErrorMessage"]
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success mt-3">
        @TempData["SuccessMessage"]
    </div>
}

<script>
    window.addEventListener("beforeunload", function () {
        let chapterId = @Model.ChapterId;
        let form = document.createElement("form");
        form.method = "POST";
        form.action = "/ReadChapter/CompleteReading/" + chapterId;
        document.body.appendChild(form);
        form.submit();
    });
</script>