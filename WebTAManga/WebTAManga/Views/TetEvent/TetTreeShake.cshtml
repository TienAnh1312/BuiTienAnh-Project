@{
    ViewData["Title"] = "Rung Cây Lì Xì Tết";
}

<h1>Rung Cây Lì Xì Tết</h1>
<p>Chào mừng bạn đến với sự kiện Tết! Nhấn vào cây để rung và nhận xu, EXP nhé!</p>

<div class="text-center position-relative">
    <img id="tetTree" src="~/images/event/tree3.png" alt="Cây Lì Xì Tết" style="max-width: 400px; cursor: pointer;" />
    <div>
        <p>Số xu hiện tại: <span id="currentCoins">@ViewBag.Coins</span></p>
        <p>Số EXP hiện tại: <span id="currentExp">@ViewBag.ExpPoints</span></p>
        <p id="resultMessage" class="mt-3"></p>
    </div>
</div>

<style>
    .shake {
        animation: shake 0.5s;
    }

    @@keyframes shake {
        0%

    {
        transform: translateX(0);
    }

    25% {
        transform: translateX(-10px);
    }

    50% {
        transform: translateX(10px);
    }

    75% {
        transform: translateX(-10px);
    }

    100% {
        transform: translateX(0);
    }

    }

    .envelope {
        position: absolute;
        width: 20px; /* Kích thước bao lì xì */
        pointer-events: none; /* Ngăn bao lì xì chặn sự kiện click */
        animation: fall 2s linear forwards; /* Hiệu ứng rơi trong 2 giây */
    }

    @@keyframes fall {
        0%

    {
        opacity: 1;
        transform: translateY(-30px) rotate(0deg);
    }

    100% {
        opacity: 0;
        transform: translateY(200px) rotate(360deg); /* Rơi xuống và xoay */
    }

    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#tetTree").click(function () {
                // Thêm hiệu ứng rung cho cây
                $("#tetTree").addClass("shake");

                // Tạo bao lì xì rơi
                createFallingEnvelopes();

                // Gửi yêu cầu rung cây qua AJAX
                $.ajax({
                    url: '@Url.Action("ShakeTree", "TetEvent")',
                    type: 'POST',
                    success: function (response) {
                        if (response.success) {
                            $("#currentCoins").text(response.totalCoins);
                            $("#currentExp").text(response.totalExp);
                            $("#resultMessage").text(response.message).css("color", "green");
                        } else {
                            $("#resultMessage").text(response.message).css("color", "red");
                        }
                        // Xóa hiệu ứng rung sau khi hoàn tất
                        setTimeout(() => $("#tetTree").removeClass("shake"), 500);
                    },
                    error: function () {
                        $("#resultMessage").text("Có lỗi xảy ra, vui lòng thử lại!").css("color", "red");
                        setTimeout(() => $("#tetTree").removeClass("shake"), 500);
                    }
                });
            });

            function createFallingEnvelopes() {
                const tree = $("#tetTree");
                const treePosition = tree.position(); // Vị trí của cây trên màn hình
                const treeWidth = tree.width();
                const container = tree.parent(); // Container bao quanh cây

                // Tạo 5 bao lì xì (có thể thay đổi số lượng)
                for (let i = 0; i < 3; i++) {
                    const envelope = $('<img>', {
                        src: '/images/event/lixi2.png',
                        class: 'envelope'
                    });

                    // Đặt vị trí ngẫu nhiên trên chiều ngang của cây
                    const randomX = treePosition.left + Math.random() * treeWidth - 20; // -20 để tránh tràn ra ngoài
                    
                    envelope.css({
                        left: randomX + 'px',
                        top: treePosition.top + '100px' // Xuất hiện từ đỉnh cây
                    });

                    // Thêm bao lì xì vào container
                    container.append(envelope);

                    // Xóa bao lì xì sau khi animation hoàn tất
                    setTimeout(() => envelope.remove(), 2000); // 2 giây (phải khớp với thời gian animation fall)
                }
            }
        });
    </script>
}